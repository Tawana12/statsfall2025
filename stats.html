<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solar Activity vs Temperature – Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- noUiSlider -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 20px;
}
.container {
    max-width: 1100px;
    margin: auto;
}
#slider {
    margin: 20px 0;
}
h2 {
    margin-top: 40px;
}
canvas {
    width: 100%;
    max-height: 350px;
}
.summary-boxes {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin: 20px 0;
}
.summary-box {
    flex: 1 1 30%;
    padding: 12px;
    border: 1px solid #ccc;
    background: #fafafa;
}
.summary-label {
    font-weight: bold;
}
</style>
</head>

<body>
<div class="container">

<h1>Solar Activity & Global Temperature Dashboard</h1>

<h3>Select Year Range</h3>
<div id="slider"></div>
<div id="rangeText" style="margin-top:10px; font-weight:bold;"></div>

<div class="summary-boxes">
    <div class="summary-box">
        <span class="summary-label">Average Sunspots</span><br>
        <span id="avgSun">–</span>
    </div>
    <div class="summary-box">
        <span class="summary-label">Average TSI</span><br>
        <span id="avgTSI">–</span>
    </div>
    <div class="summary-box">
        <span class="summary-label">Average Temp Anomaly</span><br>
        <span id="avgTemp">–</span>
    </div>
</div>

<h2>Sunspots Over Time</h2>
<canvas id="sunChart"></canvas>

<h2>TSI Over Time</h2>
<canvas id="tsiChart"></canvas>

<h2>Temperature Anomalies Over Time</h2>
<canvas id="tempChart"></canvas>

<h2>Combined Comparison</h2>
<canvas id="combinedChart"></canvas>

<h2>Temperature vs Sunspots</h2>
<canvas id="scatterSun"></canvas>

<h2>Temperature vs TSI</h2>
<canvas id="scatterTSI"></canvas>

</div>

<script>
// --- CSV PARSER ---
function csvToRows(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const cols = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
    });
}

// --- GLOBAL DATA ---
let yearly = {};
let years = [];
let charts = {};

// Load CSV files
Promise.all([
    fetch("Sunspots.csv").then(r => r.text()),
    fetch("TSI.csv").then(r => r.text()),
    fetch("Temperatures.csv").then(r => r.text())
]).then(([sunText, tsiText, tempText]) => {

    let sun = csvToRows(sunText);
    let tsi = csvToRows(tsiText);
    let temp = csvToRows(tempText);

    processData(sun, tsi, temp);
    setupSlider();
    updateDashboard();

});

function processData(sun, tsi, temp) {
    const full = ["January","February","March","April","May","June",
                  "July","August","September","October","November","December"];
    const short = ["Jan","Feb","Mar","Apr","May","Jun",
                   "Jul","Aug","Sep","Oct","Nov","Dec"];

    sun.forEach(r => {
        if (!r.Year) return;
        let yr = r.Year;
        yearly[yr] = yearly[yr] || {};
        yearly[yr].sun = full.map(m => parseFloat(r[m]) || 0)
                             .reduce((a,b)=>a+b)/12;
    });

    tsi.forEach(r => {
        let yr = r.Year;
        if (!yr || !yearly[yr]) return;
        yearly[yr].tsi = full.map(m => parseFloat(r[m]) || 0)
                             .reduce((a,b)=>a+b)/12;
    });

    temp.forEach(r => {
        let yr = r.Year;
        if (!yr || !yearly[yr]) return;
        yearly[yr].temp = short.map(m => parseFloat(r[m]) || 0)
                               .reduce((a,b)=>a+b)/12;
    });

    years = Object.keys(yearly)
                  .filter(y => yearly[y].sun && yearly[y].tsi && yearly[y].temp)
                  .sort((a,b)=>a-b);
}

// --- RANGE SLIDER ---
function setupSlider() {
    let slider = document.getElementById("slider");

    noUiSlider.create(slider, {
        start: [years[0], years[years.length-1]],
        connect: true,
        step: 1,
        orientation: "horizontal",
        range: {
            min: parseInt(years[0]),
            max: parseInt(years[years.length-1])
        },
        tooltips: true,
        format: {
            from: Number,
            to: value => Math.round(value)
        }
    });

    slider.noUiSlider.on("update", updateDashboard);
}

// --- UPDATE DASHBOARD ---
function updateDashboard() {
    let [start, end] = document.getElementById("slider").noUiSlider.get();
    start = parseInt(start);
    end   = parseInt(end);

    document.getElementById("rangeText").innerText =
        `Showing ${start} – ${end}`;

    let filteredYears = years.filter(y => y >= start && y <= end);

    let sun = filteredYears.map(y => yearly[y].sun);
    let tsi = filteredYears.map(y => yearly[y].tsi);
    let temp = filteredYears.map(y => yearly[y].temp);

    // Update summary
    document.getElementById("avgSun").innerText = (sun.reduce((a,b)=>a+b)/sun.length).toFixed(2);
    document.getElementById("avgTSI").innerText = (tsi.reduce((a,b)=>a+b)/tsi.length).toFixed(3);
    document.getElementById("avgTemp").innerText = (temp.reduce((a,b)=>a+b)/temp.length).toFixed(3);

    drawCharts(filteredYears, sun, tsi, temp);
}

// --- DRAWING CHARTS ---
function destroy(id) {
    if (charts[id]) charts[id].destroy();
}

function drawCharts(lbls, sun, tsi, temp) {

    destroy("sun");
    charts.sun = new Chart(document.getElementById("sunChart"), {
        type: "line",
        data: { labels: lbls, datasets: [{ label:"Sunspots", data:sun, borderColor:"orange"}] }
    });

    destroy("tsi");
    charts.tsi = new Chart(document.getElementById("tsiChart"), {
        type: "line",
        data: { labels: lbls, datasets: [{ label:"TSI", data:tsi, borderColor:"green"}] }
    });

    destroy("temp");
    charts.temp = new Chart(document.getElementById("tempChart"), {
        type: "line",
        data: { labels: lbls, datasets: [{ label:"Temperature", data:temp, borderColor:"red"}] }
    });

    destroy("combined");
    charts.combined = new Chart(document.getElementById("combinedChart"), {
        type: "line",
        data: {
            labels: lbls,
            datasets: [
                { label:"Sunspots (÷10)", data: sun.map(v=>v/10), borderColor:"orange"},
                { label:"TSI (−1360)", data: tsi.map(v=>v-1360), borderColor:"green"},
                { label:"Temp", data: temp, borderColor:"red"}
            ]
        }
    });

    destroy("scatterSun");
    charts.scatterSun = new Chart(document.getElementById("scatterSun"), {
        type: "scatter",
        data: { datasets: [{ label:"Temp vs Sunspots", data: lbls.map((y,i)=>({x:sun[i],y:temp[i]})), backgroundColor:"orange"}] }
    });

    destroy("scatterTSI");
    charts.scatterTSI = new Chart(document.getElementById("scatterTSI"), {
        type: "scatter",
        data: { datasets: [{ label:"Temp vs TSI", data: lbls.map((y,i)=>({x:tsi[i],y:temp[i]})), backgroundColor:"blue"}] }
    });
}

</script>

</body>
</html>
